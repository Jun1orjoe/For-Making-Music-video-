import tkinter as tk
from tkinter import filedialog
import os
import re

def parse_srt(content):
    pattern = re.compile(r'(\d+)\n(.*?)\n(.*?)\n', re.DOTALL)
    blocks = []
    for match in pattern.finditer(content + "\n"):
        idx = int(match.group(1))
        time = match.group(2).strip()
        text = match.group(3).strip()
        blocks.append((idx, time, text))
    return blocks

def build_srt(blocks):
    return "\n".join(f"{idx}\n{time}\n{text}\n" for idx, time, text in blocks)

def shift_blocks(blocks, start_idx, end_idx, new_start_idx):
    """ç”Ÿæˆæ–°çš„å¹³ç§»å­—å¹• (å‘å‰ç§»ä¸€æ ¼ï¼Œæœ€åè¡¥ç©º)"""
    original = blocks[start_idx-1:end_idx]
    shifted = []
    for i in range(len(original)):
        idx = new_start_idx + i
        time = original[i][1]
        text = original[i+1][2] if i+1 < len(original) else ""
        shifted.append((idx, time, text))
    return shifted

def process_file(input_path):
    with open(input_path, "r", encoding="utf-8") as f:
        content = f.read()
    blocks = parse_srt(content)

    total = len(blocks)
    half = total // 2  # å‰åŠæ—¥è¯­ï¼ŒååŠä¸­æ–‡

    # è‡ªåŠ¨è¯†åˆ«èŒƒå›´
    new_jp = shift_blocks(blocks, 1, half, total + 1)
    new_cn = shift_blocks(blocks, half + 1, total, total + half + 1)

    all_blocks = blocks + new_jp + new_cn
    output = build_srt(all_blocks)

    output_path = os.path.join(os.path.dirname(input_path), "output_shifted.srt")
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(output)

    print(f"âœ… å·²å®Œæˆï¼è¾“å‡ºæ–‡ä»¶ä¿å­˜ä¸º: {output_path}")
    print(f"ğŸ“Š åŸå§‹å­—å¹•æ€»æ•°: {total}ï¼Œæ—¥è¯­éƒ¨åˆ†: 1~{half}ï¼Œä¸­æ–‡å­—å¹•éƒ¨åˆ†: {half+1}~{total}")
    print(f"ğŸ†• æ–°å¢æ—¥è¯­: {total+1}~{total+half}ï¼Œæ–°å¢ä¸­æ–‡: {total+half+1}~{total*2}")

def select_and_process_file():
    root = tk.Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(
        title="è¯·é€‰æ‹©SRTå­—å¹•æ–‡ä»¶",
        filetypes=[("SRT å­—å¹•æ–‡ä»¶", "*.srt")]
    )
    if file_path:
        print(f"ğŸ“‚ ä½ é€‰æ‹©äº†æ–‡ä»¶: {file_path}")
        process_file(file_path)
    else:
        print("âŒ æ²¡æœ‰é€‰æ‹©ä»»ä½•æ–‡ä»¶ã€‚")

select_and_process_file()

